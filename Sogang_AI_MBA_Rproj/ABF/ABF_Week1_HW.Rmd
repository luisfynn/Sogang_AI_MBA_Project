---
title: "ABF_Week1_HW"
author: "taehwan.lee"
date: "2023-12-27"
output:
  word_document: default
---

```{r}
#install.packages("Quandl")
#install.packages("highcharter")
#install.packages("plotly")
#install.packages("bigmemory")
#install.packages("biganalytics")
#install.packages("ff")
#install.packages("biglm")
library(Quandl)
library(tidyverse)
library(highcharter)
library(quantmod)
library(plotly)
library(bigmemory)
library(biganalytics)
library(ff)
library(biglm)
```

```{r}
Quandl.api_key("mFJ-d-Lj4n2fvywxg_DN")
```

Quandl( code, type = c("raw", "ts", "zoo", "xts", "timeSeries"),
transform = c("","diff", "rdiff", "normalize", "cumul", "rdiff_from"),
collapse = c("","daily", "weekly", "monthly", "quarterly", "annual"),
order = c("desc", "asc"), meta = FALSE, force_irregular = FALSE, ... )

해당 함수는 R 프로그래밍 언어에서 사용되는 함수로, 주로 금융 데이터를
가져오는 데 사용됩니다. 아래는 함수의 각 매개변수에 대한 설명입니다:

1.  code: 데이터를 가져올 금융 기관 또는 데이터셋의 코드 또는 식별자를
    지정하는 매개변수입니다. Quandl에서 특정 시계열 데이터를 고유하게
    식별하는 데 사용될 수 있는 코드일 것입니다.

2.  type: 데이터의 출력 구조 유형을 지정하는 매개변수입니다. 옵션으로는
    다음이 있습니다: "raw": 원시 데이터. "ts": 시계열 객체. "zoo": Zoo
    객체. "xts": xts 객체. "timeSeries": TimeSeries 객체.

3.  transform: 데이터에 적용할 변환을 지정하는 매개변수로, 다음과 같은
    옵션이 있습니다: "": 변환 없음."diff": 차분. "rdiff": 상대 차분.
    "normalize": 정규화. "cumul": 누적. "rdiff_from": 지정된 지점에서의
    상대 차분.

4.  collapse: 데이터를 축소할 빈도를 지정하는 매개변수로, 다음과 같은
    옵션이 있습니다: "": 축소하지 않음."daily": 일일 데이터. "weekly":
    주간 데이터. "monthly": 월간 데이터. "quarterly": 분기별 데이터.
    "annual": 연간 데이터.

5.  order: 가져온 데이터의 정렬 순서를 지정하는 매개변수로, 다음과 같은
    옵션이 있습니다: "desc": 내림차순. "asc": 오름차순.

6.  meta: 출력에 메타데이터를 포함할지 여부를 나타내는 논리형
    매개변수입니다.

7.  force_irregular: 불규칙한 시계열을 강제로 생성할지 여부를 나타내는
    논리형 매개변수입니다.

8.  Slice and Dice the Data ex) mydata = Quandl("FRED/GDP",
    start_date="2001-12-31", end_date="2005-12-31")

9.  Request specific columns ex) mydata = Quandl(c("FRED/GDP.1",
    "WIKI/AAPL.4"))

```{r}
Qdata2 <- Quandl("NSE/OIL", collapse = "monthly")
head(Qdata2)
```

```{r}
Qdata3 <- Quandl("FRED/GDP", start_date = as.Date("2000-01-01"), end_date = as.Date("2020-08-31"), type = "xts")
head(Qdata3)
```

```{r}
Qdata4 = Quandl("FRED/GDP", transform = "rdiff")
head(Qdata4)
```

```{r}
#Crude Oil Prices: West Texas Intermediate
oil_daily <- Quandl("FRED/DCOILWTICO", type = "raw", collapse = "daily", start_date = "2008-01-01", end_date = "2024-01-01")
head(oil_daily)
```

```{r}
oil_weekly <- Quandl("FRED/DCOILWTICO", type = "xts", collapse = "weekly", start_date = "2008-01-01", end_date = "2024-01-01")
head(oil_weekly)
```

```{r}
oil_monthly <- Quandl("FRED/DCOILWTICO", type = "xts", collapse = "monthly", start_date = "2008-01-01", end_date = "2024-01-01")
head(oil_monthly)
```

```{r}
tail(index(oil_monthly))
```

```{r}
mdy(last(index(oil_monthly)))
```

```{r}
#mdy 함수는 날짜를 월-일-년(월/일/년) 형식으로 파싱하고 Date 객체로 반환하는 함수입니다
#index(oil_monthly):시계열 데이터에서 시간 정보를 나타내는 인덱스를 추출합니다. 여기서는 날짜 또는 기간에 해당하는 값들이 추출됩니다.
#last(...): 추출된 값 중에서 마지막 값을 선택합니다. 따라서 이 부분은 시계열 데이터의 마지막 시간 인덱스를 나타냅니다.
index(oil_monthly) = seq(mdy("01/01/2008"), mdy(last(index(oil_monthly))), by = "months")
tail(index(oil_monthly))
```

```{r}
head(index(oil_monthly))
```

```{r}
hchart(oil_monthly)
```

```{r}
highchart(type = "stock") %>% hc_add_series(oil_monthly, color = "cornflowerblue") %>%
  hc_yAxis(
    title = list(text = "monthly price"),
    labels = list(format = "${value}"), #y 축값에 $를 붙이라는 의미
    opposite = FALSE #y title과 label이 왼쪽에 위치한다. //TRUE = 오른쪽에 위치
  ) %>% hc_add_theme(hc_theme_flat())
```

```{r}
Apple <- getSymbols("AAPL", from = "2020-01-01", to = "2023-12-31", auto.assign = F)
SP500 <- getSymbols("^GSPC", from = "2020-01-01", to = "2023-12-31", auto.assign = F) #SP500 index
Hanwha_Life <- getSymbols("088350.KS", from = "2020-01-01", to = "2023-12-31", auto.assign = F) 
Samsung_Life <- getSymbols("032830.KS", from = "2020-01-01", to = "2023-12-31", auto.assign = F) 
Samsung_Elec <- getSymbols("005930.KS", from = "2020-01-01", to = "2023-12-31", auto.assign = F) 
#auto.assign = FALSE로 설정되어 있다면, 데이터를 받아온 후에는 현재 R 작업 환경에 자동으로 할당되지 않는다.
#getSymbols("005930.KS", from = "2020-01-01", to = "2023-12-31", auto.assign = T) 로 할 경우, 데이터를 받아와서
#005930.KS에 저장하게 된다. 
#getSymbols("005930.KS", from = "2020-01-01", to = "2023-12-31", auto.assign = T) 
```

```{r}
chart_Series(Samsung_Elec$`005930.KS.Close`) #tick mark: 숫자 1 옆. 특수문자로 시작할 경우 tick mark 붙여야 함
```

```{r}
# knit시 오류로 주석처리함
# chart_Series(`005930.KS`$`005930.KS.Close`)
```

```{r}
getSymbols("USD/KRW", src ="oanda", from = Sys.Date() - 180, to = Sys.Date())
chart_Series(USDKRW) #getSymbols의 auto.assign 기본값은 TRUE이므로, 위 명령을 실행하면 USDKRW 변수에 데이터를 저장한다.
```

```{r}
#우리나라 실업율
실업율 <- getSymbols("LRHUTTTTKRA156N", src = "FRED", from = "1998-01-01", to = "2021-12-31", auto.assign = F)
chart_Series(실업율)
```

```{r}
SP500 <- getSymbols("^GSPC", from = "2010-01-01", to = "2023-12-31", auto.assign = F)
plot(SP500[,4], col = "gray", type = "l", main = "S&P 500 Index")
rolling_average = rollapply(SP500[,4], 100, mean) # 최근 100개의 평균을 구한다.
lines(rolling_average, col = "red", lwd = 2)
rolling_volatility = rollapply(SP500[,4], 200, sd)
plot(rolling_volatility)
```

```{r}
head(SP500)
```

```{r}
B <- new.env() # 새로운 환경이 생성되며, 이 환경은 변수, 함수, 그리고 다른 환경을 담을 수 있는 공간이 됩니다.
getSymbols("BMW.DE", env = B, src = "yahoo", from = "2010-01-01", to = "2013-12-31")
#2010년 1월 1일부터 2013년 12월 31일까지의 BMW 주식 데이터를 Yahoo Finance에서 가져와서 환경 B에 저장하는 작업을 수행합니다. 가져온 데이터는 B라는 환경 내에 "BMW.DE"라는 이름으로 변수로 저장됨
BMW <- B$BMW.DE
head(BMW)
chartSeries(BMW, multi.col = TRUE, theme = "white")
addBBands() #add the Bollinger Bands
addMACD() #the MACD trend-follwing momentum indicator
```

```{r}
B.Return <- log(BMW$BMW.DE.Close / BMW$BMW.DE.Open)
qqnorm(B.Return,
       main = "Normal Probability Plot of BMW daily Log Returns",
       xlab = "Theoretical Quantiles",
       ylab = "Sample Quantiles")
qqline(B.Return, col = "red", lwd = 2.5)
```

```{r}
#Seasonal Decomposition of Times Series by Loess
# stl 함수는 R의 시계열 데이터에 대해 STL (Seasonal-Trend decomposition using LOESS) 분해를 수행하는 함수입니다. STL은 시계열 데이터를 계절성, 추세, 그리고 나머지(residuals)로 분해하여 각 구성 요소를 개별적으로 추정합니다.
# 
# 여기서 stl 함수의 몇 가지 주요 매개변수에 대한 설명
# 
# - nottem: STL 분해를 수행할 시계열 데이터입니다. 여기서는 nottem이라는 변수가 해당 데이터를 나타내는 것으로 가정합니다.
# 
# - s.window: 계절성 구성 요소를 추정할 때 사용되는 LOESS(smoothed time-series) 창의 크기입니다. "periodic"으로 설정하면 자동으로 계절성을 결정
# 
# - t.window: 추세(trend) 구성 요소를 추정할 때 사용되는 LOESS 창의 크기
# 
# - t.jump: 추세(trend)의 점프(jump) 또는 간격을 결정합니다. 이 매개변수는 추세를 추정할 때 사용되는 창을 얼마나 건너뛸지를 결정
# 
# 이러한 설정을 사용하여 stl(nottem, s.window = "periodic", t.window = 70, t.jump = 1)는 nottem 시계열 데이터에 대한 STL 분해를 수행합니다. 계절성은 자동으로 결정되고, 추세는 LOESS 창 크기가 70이고 간격이 1인 설정으로 추정한다

#t.jump 값을 크게 하면 trend 곡선이 변한다.
plot(stl(nottem, s.window = "periodic", t.window = 70, t.jump = 1), main = "Average Monthly Temperatures at Nottingham, 1920-1939")
```

```{r}
#Candl Stick Chart 그려보기
df <- data.frame(Date = index(Samsung_Elec), coredata(Samsung_Elec))
df <- tail(df, 30)

fig <- df %>%
  plot_ly(
    x = ~Date,
    type = "candlestick",
    open = ~X005930.KS.Open,
    close = ~X005930.KS.Close,
    high = ~X005930.KS.High,
    low = ~X005930.KS.Low
  )

# 하단 range slider on/off설정 F:off, T:on
fig <-
  fig %>%
  layout(title = "Basic Candlestick Chart(Samsung Electronics", xaxis = list(rangeslider = list(visible = F)))

fig
```

```{r}
# read.big.matrix는 R 프로그래밍 언어의 bigmemory 패키지에 속한 함수 중 하나입니다. bigmemory 패키지는 대용량 메모리 매핑을 통해 대규모 데이터를 효율적으로 다루는 데 사용되는 도구를 제공합니다.
# read.big.matrix 함수는 대용량의 행렬 데이터를 효율적으로 메모리에 읽어오는 데 사용됩니다. 특히, 메모리에 맞지 않는 큰 데이터셋을 작은 조각으로 나누어 읽어들일 때 유용합니다.
x <- read.big.matrix("bmw.csv", header = TRUE, type = "double")
head(x)
```

```{r}
x <- x[,-1]
head(x)
```

```{r}
class(x)
```

```{r}
# lapply 함수는 R에서 리스트에 적용되는 함수로, 주어진 리스트의 각 요소에 함수를 적용하여 리스트를 반환합니다. 여기서 1:10은 1부터 10까지의 정수로 이루어진 리스트를 나타냅니다. 따라서 lapply(1:10, function(i){bigkmeans(x, center = i, iter.max = 100, nstart = 10)})은 1부터 10까지의 정수를 가지고 있는 리스트에 대해 bigkmeans 함수를 각각 적용하는 것을 의미합니다.

# 이 코드에서 사용된 함수와 매개변수들에 대한 설명은 다음과 같습니다:
# 1:10: 1부터 10까지의 정수로 이루어진 리스트를 생성합니다.
# function(i){...}: 리스트의 각 요소에 대해 실행될 함수를 정의합니다. 함수의 인자 i는 리스트의 각 요소를 나타냅니다.
# bigkmeans(x, center = i, iter.max = 100, nstart = 10): bigkmeans는 대용량 데이터셋에 대해 k-평균 군집화를 수행하는 함수입니다.
# x: 군집화를 수행할 데이터셋.
# center = i: 클러스터의 개수를 i로 설정합니다. i는 1부터 10까지의 정수로 변화하면서 군집화가 수행됩니다.
# iter.max = 100: 반복 횟수의 상한값을 설정합니다.
# nstart = 10: 무작위 초기화를 10번 시도하며 가장 좋은 결과를 선택합니다.
# 따라서 lapply(1:10, function(i){bigkmeans(x, center = i, iter.max = 100, nstart = 10)})은 군집화를 클러스터 수가 1부터 10까지 변화하면서 각각 수행하고, 그 결과를 리스트로 반환합니다. 반환된 리스트의 각 요소는 각 클러스터 수에 대한 군집화 결과입니다.
Results <- lapply(1:10, function(i){bigkmeans(x, center = i, iter.max = 100, nstart = 10)})
Within <- lapply(Results, function(x) sum(x$withinss)/(10^15)) 
#10^15 로 나눈 이유는 Within cluster sum of squares by cluster 값이 {값}*e^15로 표기 되기 때문에 e^15를 없애기 위함이다. 
plot(1:10, Within, type = "b", xlab = "Number of Clusters", ylab = "Within Sum of Square")
```

```{r}
Results
```

```{r}
R3 <- bigkmeans(x, center = 3, iter.max = 100, nstart = 10)
summary(R3)
```

```{r}
R3$cluster
```

```{r}
R3$centers
```

```{r}
colnames(x)
```

```{r}
# read.csv.ffdf는 R 언어의 ff 패키지에서 제공되는 함수로, 대용량 CSV 파일을 메모리에 읽어들이기 위한 함수입니다. ff 패키지는 데이터를 파일로부터 읽거나 파일로 쓰는 등의 작업을 수행할 때 메모리를 효율적으로 활용할 수 있도록 도와주는 패키지입니다.
# 여기서 read.csv.ffdf 함수는 ff 패키지에서 제공되는 대용량 데이터를 처리하기 위한 클래스인 ffdf 클래스의 객체로 데이터를 읽어들입니다.
download.file("http://www.irs.gov/file_source/pub/irs-soi/12zpallagi.csv", "soi.csv")
x <- read.csv.ffdf(file="soi.csv", header = T)
class(x)
```

```{r}
BigModel <- biglm(A02300~A00200+AGI_STUB+NUMDEP+MARS2, data = x)
summary(BigModel) #변수A02300: 국가에서 지불하는 실업수당당
```

```{r}
summary(BigModel)$rsq #대용량 데이터에 대한 선형 회귀 모델(biglm 객체)의 결정 계수 (R-squared) 값
```
